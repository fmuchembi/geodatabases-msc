{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Housing Filters</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="{% static 'housing/styles.css' %}">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="filter-section">
                <h3>Student Housing</h3>
                <h5>Stadt Muenster,
                    Student Housing recommendation on fly based on users parameters </h5>
                <div class="space-y-3">
                    <div>
                    <p>District</p>
                   <!--Include Districts-->
                    </div>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="near_bus_stop" class="rounded text-blue-600">
                        <span>Bus Stop</span>
                    </label>
                    <!--Update so the filtering is by name of university building-->
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="near_university" class="rounded text-blue-600">
                        <span>University Buildings</span>
                    </label>
                    
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="near_green_spaces" class="rounded text-blue-600">
                        <span>Green Spaces</span>
                    </label>
                     <!--add option of soccer-->
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="near_outdoor_activities" class="rounded text-blue-600">
                        <span>Outdoor Activities</span>
                    </label>
                    <!--Add filter for Prices-->
                </div>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([51.505, -0.09], 13);

        var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '© Esri'
        });

        var baseLayers = {
            "OpenStreetMap": osmLayer,
            "Satellite": satelliteLayer
        };

        L.control.layers(baseLayers).addTo(map);

        var addressLayer;

        function updateMapMarkers(houses) {
            if (addressLayer) {
                map.removeLayer(addressLayer);
            }

            var markers = [];
            houses.forEach(function(house) {
                var marker = L.marker([house.latitude, house.longitude], {
                    icon: L.divIcon({
                        html: '<i class="fas fa-building custom-icon"></i>',
                        iconSize: [0, 0],
                        iconAnchor: [15, 30],
                        popupAnchor: [0, -30]
                    })
                });

                marker.bindPopup('<div class="address-popup">' + house.name + '</div>');
                markers.push(marker);
            });

            addressLayer = L.featureGroup(markers).addTo(map);

            if (markers.length > 0) {
                map.fitBounds(addressLayer.getBounds());
            }

            console.log(`Updated map with ${houses.length} houses`);
        }

        function applyFilters() {
            const filters = {
                near_bus_stop: document.getElementById('near_bus_stop').checked,
                near_outdoor_activities: document.getElementById('near_outdoor_activities').checked
            };

            const queryParams = new URLSearchParams(filters);
            
            console.log('Fetching:', `/filter-houses/?${queryParams.toString()}`);
            
            fetch(`/filter-houses/?${queryParams.toString()}`)
                .then(response => response.json())
                .then(houses => {
                    console.log('Received houses:', houses);
                    updateMapMarkers(houses);
                })
                .catch(error => {
                    console.error('Error fetching houses:', error);
                });
        }

        const checkboxes = ['near_bus_stop', 'near_university', 'near_green_spaces', 'near_outdoor_activities'];
        checkboxes.forEach(id => {
            document.getElementById(id).addEventListener('change', applyFilters);
        });

        fetch('/filter-houses/')
            .then(response => response.json())
            .then(houses => {
                console.log('Initial houses:', houses);
                updateMapMarkers(houses);
            })
            .catch(error => {
                console.error('Error loading initial houses:', error);
            });
    </script>
</body>
</html>